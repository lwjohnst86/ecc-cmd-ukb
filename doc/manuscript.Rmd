---
output: html_document
---

```{r setup, include=FALSE}
# root directory one down if using `prodigenr`
knitr::opts_chunk$set(echo = FALSE, eval = FALSE)
devtools::load_all()
library(NetCoupler)
library(rsample)
set.seed(4125612)
```

```{r load-data}
proj_data <- prepare_data_for_netcoupler_analysis()
proj_data_cv <- proj_data %>%
    training() %>%
    create_cv_splits()
```

```{r make-network}
# network_results[[1]]
calc_network_weights <- function(.tbl, .graph) {
    .tbl %>%
        as.data.frame() %>%
        analyze_nc_standardize_mtb_vars() %>%
        na.omit() %>% 
        NetCoupler:::nc_tbl_adjacency_graph(.graph)
}

network_weights <- map2(
    proj_data_cv$splits, 
    network_results, 
    calc_network_weights
)
usethis::use_data(network_weights, overwrite = TRUE)
```


```{r make-network-2}
library(tidygraph)

network_results_combined <- network_weights %>% 
    reduce(graph_join, by = "name")

network_mean_weights <- tbl_graph(
    nodes = network_results_combined %>%
        activate("nodes") %>%
        as_tibble(),
    edges = network_results_combined %>%
        activate("edges") %>%
        as_tibble() %>%
        group_by(from, to) %>%
        summarise(
            weight = mean(weight),
            weight_lower = quantile(weight, probs = 0.05),
            weight_upper = quantile(weight, probs = 0.95),
            .groups = "drop"
        ) 
) 

network_mean_weights %>%
    tidy_node_names_column() %>% 
    plot_network_graph()

# network_plot
# ggsave(here::here("doc/images/network-plot2.svg"), network_plot)
```

```{r}
# exposure_estimate_results %>% 
#     count(exposure, index_node, effect)

estimation_results <- bind_rows(
    outcome_estimate_results %>%
        rename(external_variable = outcome) %>%
        summarise_estimate_means(),
    exposure_estimate_results %>%
        rename(external_variable = exposure) %>%
        summarise_estimate_means() %>%
        filter(external_variable != "sitting_height")
)

tbl_graph_data <- network_and_estimates_as_tbl_graph(
    estimation_results,
    network_mean_weights
)

estimation_plot <- tbl_graph_data %>% 
    tidy_node_names_column() %>% 
    plot_estimation_with_network(c("LHR", "LL", "Height"),
                                 "HbA1c")

ggsave(here::here("doc/images/netcoupler-results.svg"), estimation_plot,
       width = 9, height = 6)
```

```{r}
# exposure_estimates_prep %>%
#     filter(effect == "direct") %>% 
#     select(exposure, index_node, estimate) %>% 
#     mutate(estimate = round(estimate, 2) * 10) %>% 
#     mutate(across(c(exposure, index_node), tidy_node_names))
```

# Title page

Title:

<!-- First, middle initial, last, highest academic degree -->
Authors:

<!-- During time of study. -->
Affiliation:

Corresponding author:

- Name:
- Current address:
- Phone number:
- Fax number:
- Email:

# Abstract

Objective:

Research Design and Methods:

Results:

Conclusions:

# Introduction 

# Research Design and Methods

# Results

# Conclusions

# Acknowledgements

# References

# Tables

# Figures

# Supplemental Material
