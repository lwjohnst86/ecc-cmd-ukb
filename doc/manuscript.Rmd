---
output: html_document
---

```{r setup, include=FALSE}
# root directory one down if using `prodigenr`
knitr::opts_chunk$set(echo = FALSE, eval = FALSE)
devtools::load_all()
library(NetCoupler)
library(rsample)
conflicted::conflict_prefer("filter", "dplyr")
set.seed(4125612)
```

```{r load-data}
proj_data <- prepare_data_for_netcoupler_analysis()
proj_data_cv <- proj_data %>%
    training() %>%
    create_cv_splits()
```

```{r make-network}
# network_results[[1]]

# network_plot <- proj_data_cv %>% 
#     map(~ as.data.frame(.x) %>% nc_standardize(starts_with("mtb"))) %>% 
#     nc_plot_network(metabolic_network,
#                     .fn_node_rename = tidy_network_node_names)

# network_plot
# ggsave(here::here("doc/images/network-plot2.svg"), network_plot)
```

```{r exposure-model-estimates}
# model_exposure_estimates <- analyze_nc_exposure(project_data_nc, metabolic_network)
model_exposure_estimates <- project_data_nc_std %>%
    nc_exposure_estimates(
        metabolic_network,
        .exposure = "leg_height_ratio",
        .adjustment_vars = c("age", "sex", "waist_circumference"),
        .model_function = lm
    )

# usethis::use_data(model_exposure_estimates, overwrite = TRUE)

model_exposure_estimates %>% 
    mutate(term = str_replace(term, "sexMale", "sex")) %>% 
    nc_classify_effects() %>% 
    filter(direct_effect == "direct") 

model_exposure_estimates_hgt <- project_data_nc_std %>%
    nc_exposure_estimates(
        metabolic_network,
        .exposure = "standing_height",
        .adjustment_vars = c("age", "sex", "waist_circumference"),
        .model_function = lm
    )

# usethis::use_data(model_exposure_estimates_hgt, overwrite = TRUE)

model_exposure_estimates_hgt %>% 
    mutate(term = str_replace(term, "sexMale", "sex")) %>% 
    nc_classify_effects()

model_exposure_estimates_ll <- project_data_nc_std %>%
    nc_exposure_estimates(
        metabolic_network,
        .exposure = "leg_length",
        .adjustment_vars = c("age", "sex", "waist_circumference"),
        .model_function = lm
    )

# usethis::use_data(model_exposure_estimates_ll, overwrite = TRUE)

model_exposure_estimates_ll %>% 
    mutate(term = str_replace(term, "sexMale", "sex")) %>% 
    nc_classify_effects()
```


```{r plot-exposure-estimates}
model_nodes <-
    data_frame(name = c(
        unique(tidy_model_exposure$exposure),
        tidy_model_exposure$index_node
    ))
model_edges <- tidy_model_exposure %>% 
    mutate(to = as.numeric(as.factor(index_node)) + 1,
           from = 1) %>% 
    select(from, to, estimate, p.value)

tbl_graph(nodes = model_nodes,
          edges = model_edges) %>% 
    ggraph("tree") +
    geom_edge_link2(
        aes(colour = estimate, width = -log10(p.value))
        # arrow = grid::arrow(ends = "first", length = unit(0.2, "cm"), type = "closed")
    ) +
    scale_edge_colour_gradient2(mid = "gray80") +
    scale_edge_width(range = c(0.75, 2)) +
    coord_cartesian(xlim = c(-10.1, 10.1)) +
    geom_node_point() +
    geom_node_label(aes(label = name))
```

```{r}
outcome_results <- model_outcome_estimates %>% 
    mutate(term = str_replace(term, "sexMale", "sex")) %>% 
    nc_classify_effects() %>% 
    mutate(
        direction = case_when(estimate > 0 ~ "(+)",
                              estimate < 0 ~ "(-)",
                              TRUE ~ ""),
        effect = as.character(glue::glue("{direct_effect} {direction}"))
    ) %>%
    select(outcome, index_node, effect) %>% 
    arrange(desc(effect), index_node)
View(outcome_results)
usethis::use_data(outcome_results, overwrite = TRUE)

exposure_results <- bind_rows(
    model_exposure_estimates %>%
        mutate(term = str_replace(term, "sexMale", "sex")) %>%
        nc_classify_effects(),
    model_exposure_estimates_hgt %>%
        mutate(term = str_replace(term, "sexMale", "sex")) %>%
        nc_classify_effects(),
    model_exposure_estimates_ll %>%
        mutate(term = str_replace(term, "sexMale", "sex")) %>%
        nc_classify_effects()
    ) %>%
    mutate(
        direction = case_when(estimate > 0 ~ "(+)",
                              estimate < 0 ~ "(-)",
                              TRUE ~ ""),
        effect = as.character(glue::glue("{direct_effect} {direction}"))
    ) %>%
    select(exposure, index_node, effect) %>%
    arrange(exposure, desc(effect), index_node) %>%
    pivot_wider(names_from = exposure, values_from = effect)
View(exposure_results)
usethis::use_data(exposure_results, overwrite = TRUE)
```


# Title page

Title:

<!-- First, middle initial, last, highest academic degree -->
Authors:

<!-- During time of study. -->
Affiliation:

Corresponding author:

- Name:
- Current address:
- Phone number:
- Fax number:
- Email:

# Abstract

Objective:

Research Design and Methods:

Results:

Conclusions:

# Introduction 

# Research Design and Methods

# Results

# Conclusions

# Acknowledgements

# References

# Tables

# Figures

# Supplemental Material
