---
bibliography: 
    - /path/to/bib
csl:
    - /path/to/csl # something like vancouver
output: word_document
---

```{r setup, include=FALSE}
# root directory one down if using `prodigenr`
knitr::opts_chunk$set(echo = FALSE)
devtools::load_all()
library(dplyr)
library(NetCoupler)
library(ggraph)
library(tidygraph)
```

```{r load-data}
project_data <- load_data() %>% 
    rename(hba1c = mtb_glycated_haemoglobin_hba1c) %>% 
    select(
        # More than 25% missing for these variables.
        -mtb_microalbumin_in_urine,
        -mtb_lipoprotein_a,
        # Glucose should probably not be in models with HbA1c as outcome
        -mtb_glucose,
        # These aren't really "metabolic" variables.
        -mtb_diastolic_blood_pressure,
        -mtb_systolic_blood_pressure
    ) %>% 
    mutate(leg_height_ratio = leg_height_ratio * 100)

project_data_nc <- project_data %>% 
    select(-age_of_t2dm_diagnosis) %>% 
    # I want to use .regressed_on = c("age", "sex", "body_mass_index")),
    # but there is a problem with one of the variables having "NA/NaN/Inf" error,
    # and I can't resolve it right now. Will do later point.
    mutate(t2dm_status = if_else(is.na(t2dm_status), FALSE, t2dm_status)) %>% 
    na.omit() %>% 
    nc_standardize(.vars = vars(starts_with("mtb_")))
```


```{r make-network}
# metabolic_network <- analyze_nc_network(project_data_nc)

w_adj_matrix <- NetCoupler:::adjacency_matrix(metabolic_network) * 
    NetCoupler:::partial_corr_matrix(project_data_nc %>% select(starts_with("mtb_")))

adj_graph <- igraph::graph.adjacency(w_adj_matrix, weighted = TRUE, mode = "undirected")

as_tbl_graph(adj_graph) %>% create_layout(layout = "stress")
adj_graph %>% 
    as_tbl_graph() %>% 
    mutate(name = tidy_metabolic_names(name)) %>% 
    activate(edges) %>% 
    mutate(weight_label = if_else(abs(weight) < 0.4, "", as.character(round(weight, 2)))) %>% 
    ggraph("stress") +
    geom_edge_bend(aes(colour = weight, width = abs(weight), label = weight_label),
                   label_dodge = ) +
    scale_edge_colour_gradient2(mid = "gray80") +
    scale_edge_width(guide = FALSE, range = c(0.75, 2)) +
    geom_node_text(aes(label = name), repel = TRUE) +
    ggraph::theme_graph() +
    coord_cartesian(xlim = c(-2.1, 2.1))
    
```


```{r make-model-estimates}
# model_outcome_estimates <- analyze_nc_outcome(project_data_nc, metabolic_network)

tidy_model_outcome <- model_outcome_estimates %>% 
    tidy_nc_estimates() %>% 
    mutate(p.value = p.adjust(p.value, method = "BH"))

model_nodes <-
    data_frame(name = c(
        unique(tidy_model_outcome$outcome),
        tidy_model_outcome$index_node
    ))
model_edges <- tidy_model_outcome %>% 
    mutate(to = as.numeric(as.factor(index_node)) + 1,
           from = 1) %>% 
    select(from, to, estimate, p.value)

tbl_graph(nodes = model_nodes,
          edges = model_edges) %>% 
    ggraph("tree") +
    geom_edge_link2(
        aes(colour = estimate, width = -log10(p.value))
        # arrow = grid::arrow(ends = "first", length = unit(0.2, "cm"), type = "closed")
    ) +
    scale_edge_colour_gradient2(mid = "gray80") +
    scale_edge_width(range = c(0.75, 2)) +
    coord_cartesian(xlim = c(-10.1, 10.1)) +
    geom_node_point() +
    geom_node_label(aes(label = name))

# model_exposure_estimates <- analyze_nc_exposure(project_data_nc, metabolic_network)

tidy_model_exposure <- model_exposure_estimates %>% 
    tidy_nc_estimates() %>% 
    mutate(p.value = p.adjust(p.value, method = "BH")) %>% 
    rename(exposure = outcome)

model_nodes <-
    data_frame(name = c(
        unique(tidy_model_exposure$exposure),
        tidy_model_exposure$index_node
    ))
model_edges <- tidy_model_exposure %>% 
    mutate(to = as.numeric(as.factor(index_node)) + 1,
           from = 1) %>% 
    select(from, to, estimate, p.value)

tbl_graph(nodes = model_nodes,
          edges = model_edges) %>% 
    ggraph("tree") +
    geom_edge_link2(
        aes(colour = estimate, width = -log10(p.value))
        # arrow = grid::arrow(ends = "first", length = unit(0.2, "cm"), type = "closed")
    ) +
    scale_edge_colour_gradient2(mid = "gray80") +
    scale_edge_width(range = c(0.75, 2)) +
    coord_cartesian(xlim = c(-10.1, 10.1)) +
    geom_node_point() +
    geom_node_label(aes(label = name))

```


# Title page

Title:

<!-- First, middle initial, last, highest academic degree -->
Authors:

<!-- During time of study. -->
Affiliation:

Corresponding author:

- Name:
- Current address:
- Phone number:
- Fax number:
- Email:

# Abstract

Objective:

Research Design and Methods:

Results:

Conclusions:

# Introduction 

# Research Design and Methods

# Results

# Conclusions

# Acknowledgements

# References

# Tables

# Figures

# Supplemental Material
