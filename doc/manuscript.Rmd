---
output: html_document
---

```{r setup, include=FALSE}
# root directory one down if using `prodigenr`
knitr::opts_chunk$set(echo = FALSE, eval = FALSE)
devtools::load_all()
library(NetCoupler)
library(rsample)
set.seed(4125612)
```

```{r load-data}
proj_data <- prepare_data_for_netcoupler_analysis()
proj_data_cv <- proj_data %>%
    training() %>%
    create_cv_splits()
```

```{r make-network}
# network_results[[1]]
calc_network_weights <- function(.tbl, .graph) {
    .tbl %>%
        as.data.frame() %>%
        analyze_nc_standardize_mtb_vars() %>%
        na.omit() %>% 
        NetCoupler:::nc_tbl_adjacency_graph(.graph)
}

network_weights <- map2(
    proj_data_cv$splits, 
    network_results, 
    calc_network_weights
)
usethis::use_data(network_weights, overwrite = TRUE)
```


```{r make-network-2}
library(tidygraph)

network_results_combined <- network_weights %>% 
    reduce(graph_join, by = "name")

network_mean_weights <- tbl_graph(
    nodes = network_results_combined %>%
        activate("nodes") %>%
        as_tibble(),
    edges = network_results_combined %>%
        activate("edges") %>%
        as_tibble() %>%
        group_by(from, to) %>%
        summarise(
            weight = mean(weight),
            weight_lower = quantile(weight, probs = 0.05),
            weight_upper = quantile(weight, probs = 0.95),
            .groups = "drop"
        ) 
) 

network_mean_weights %>%
    tidy_node_names_column() %>% 
    plot_network_graph()

# network_plot
# ggsave(here::here("doc/images/network-plot2.svg"), network_plot)
```

```{r}
# exposure_estimate_results %>% 
#     count(exposure, index_node, effect)

estimation_results <- bind_rows(
    outcome_estimate_results %>%
        rename(external_variable = outcome) %>%
        summarise_estimate_means(),
    exposure_estimate_results %>%
        rename(external_variable = exposure) %>%
        summarise_estimate_means() %>%
        filter(external_variable != "sitting_height")
)

tbl_graph_data <- network_and_estimates_as_tbl_graph(
    estimation_results,
    network_mean_weights
)

estimation_plot <- tbl_graph_data %>% 
    tidy_node_names_column() %>% 
    plot_estimation_with_network(c("LHR", "LL", "Height"),
                                 "HbA1c")

ggsave(here::here("doc/images/netcoupler-results.svg"), estimation_plot,
       width = 9, height = 6)
```

```{r}
# exposure_estimates_prep %>%
#     filter(effect == "direct") %>% 
#     select(exposure, index_node, estimate) %>% 
#     mutate(estimate = round(estimate, 2) * 10) %>% 
#     mutate(across(c(exposure, index_node), tidy_node_names))
```

# Title page

Title:

<!-- First, middle initial, last, highest academic degree -->
Authors:

<!-- During time of study. -->
Affiliation:

Corresponding author:

- Name:
- Current address:
- Phone number:
- Fax number:
- Email:

# Abstract
**The metabolic pathways between components of stature and HbA1c: A causal
structure learning approach in the UK Biobank**

Luke W Johnston, Clemens Wittenbecher, Helene T Vistisen, Christina C Dahm, Daniel R Witte

**Background and aims**:
Shorter relative adult leg length (LL), a marker of adverse growth conditions
during early childhood, is associated with a higher risk for type 2 diabetes.
How this link is mediated metabolically is not well known in humans. Our aim was
to identify how the components of stature influence the metabolic profile in
adults and the consequent risk for type 2 diabetes through higher HbA1c.

**Materials and methods**:
We used 367,838 participants (176,420 men, 191,418 women) from UK Biobank,
excluding prevalent diabetes cases. We applied a causal structure learning
algorithm (NetCoupler) to identify the most likely pathways between an exposure,
a metabolic network, and an outcome. The algorithm: constructs an estimated
network for the metabolic variables; iterates through each variable, linking it
to either the exposure or outcome; and identifies links as potential direct
effects that exist when independent of neighbouring variables in the network.
For this study, we used height, LL, and leg-to-height ratio (LHR) as the
individual exposures and HbA1c as the outcome. The metabolic variables chosen to
form part of the network were: gamma-glutamyltransferase (GGT), alanine
aminotransferase (ALT), aspartate aminotransferase (AST), TG, LDL, HDL, total
cholesterol, C-reactive protein (CRP), apolipoprotein A and B, and albumin. Age,
sex, and waist circumference adjustments were applied in the algorithm.

**Results**:
The initial network generated from the metabolic variables identified links
expected between metabolic variables (Figure), such as between
HDL-LDL-Cholesterol-TG (serum lipid profile) and GGT-ALT-AST (liver function). A
darker blue link indicates a positive relationship, while darker orange
indicates a negative relationship. Between the metabolic network variables and
HbA1c there were positive relationships between ALT, GGT, and CRP. For the
stature components, there were negative relationships between: LHR, LL, and
height on TG; LHR, LL on CRP and ALT; and, LL and height on GGT. There were
positive relationships between: LL on HDL. Based on the NetCoupler algorithm, we
found that LHR, LL, and height were likely causally linked with HbA1c through
GGT, ALT, and CRP.

**Conclusion**:
Our findings suggest that overall childhood growth conditions that result in
relatively longer legs and a taller stature may confer some protection against
dysregulation of glucose metabolism and possibly type 2 diabetes (from higher
HbA1c) potentially through preserved liver function (through GGT and ALT) and
through generally lower inflammation (via CRP).

Objective:

Research Design and Methods:

Results:

Conclusions:

# Introduction 

# Research Design and Methods

# Results

# Conclusions

# Acknowledgements

# References

# Tables

# Figures

# Supplemental Material
